<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vditor</title>
    <!-- Load Vditor from CDN for immediate usage -->
    <link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
    <script src="https://unpkg.com/vditor/dist/index.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #vditor {
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="vditor"></div>
    <script>
        let vditor;

        // Swift Bridge
        const bridge = {
            postMessage: function (name, data) {
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers[name]) {
                    window.webkit.messageHandlers[name].postMessage(data);
                }
            }
        };

        function initVditor(content) {
            vditor = new Vditor('vditor', {
                value: content || '',
                mode: 'ir', // Instant Rendering
                height: window.innerHeight,
                outline: { enable: true },
                cache: { enable: false },
                toolbar: [
                    'emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|',
                    'list', 'ordered-list', 'check', 'outdent', 'indent', '|',
                    'quote', 'line', 'code', 'inline-code', 'insert-before', 'insert-after', '|',
                    'upload', 'record', 'table', '|',
                    'undo', 'redo', '|',
                    'fullscreen', 'edit-mode',
                    {
                        name: 'save',
                        tip: 'Save',
                        className: 'right',
                        icon: '<svg><use xlink:href="#vditor-icon-check"></use></svg>',
                        click: () => {
                            bridge.postMessage('save', vditor.getValue());
                        }
                    }
                ],
                upload: {
                    handler: (files) => {
                        // Convert file to base64 and send to Swift
                        const file = files[0];
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const base64 = e.target.result.split(',')[1];
                            bridge.postMessage('uploadImage', {
                                name: file.name,
                                data: base64
                            });
                        };
                        reader.readAsDataURL(file);
                        return null; // Prevent default upload
                    }
                },
                input: (value) => {
                    // Auto save or sync logic if needed
                },
                after: () => {
                    bridge.postMessage('ready', null);
                }
            });
        }

        // Called from Swift
        function updateContent(content) {
            if (vditor) {
                vditor.setValue(content);
            } else {
                initVditor(content);
            }
        }

        function insertImage(url, alt) {
            if (vditor) {
                vditor.insertValue(`![${alt}](${url})`);
            }
        }
    </script>
</body>

</html>