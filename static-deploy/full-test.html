<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整流程测试</title>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css">
    <script src="config-manager.js"></script>
    <script src="github-service.js"></script>
    <script src="image-service.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div id="app">
        <h1>发布按钮问题 - 完整流程测试</h1>

        <div class="test-section">
            <h2>步骤1: 检查脚本加载</h2>
            <p :class="configManagerLoaded ? 'success' : 'error'">
                ✓ configManager: {{ configManagerLoaded ? '已加载' : '未加载' }}
            </p>
            <p :class="githubServiceLoaded ? 'success' : 'error'">
                ✓ githubService: {{ githubServiceLoaded ? '已加载' : '未加载' }}
            </p>
            <p :class="imageServiceLoaded ? 'success' : 'error'">
                ✓ imageService: {{ imageServiceLoaded ? '已加载' : '未加载' }}
            </p>
        </div>

        <div class="test-section">
            <h2>步骤2: 设置测试配置</h2>
            <el-button @click="setTestConfig" type="primary">设置测试配置</el-button>
            <p v-if="configSet" class="success">✓ 配置已设置</p>
        </div>

        <div class="test-section">
            <h2>步骤3: 验证配置状态</h2>
            <el-button @click="checkConfigStatus" type="primary">检查配置</el-button>
            <div v-if="configStatus">
                <p :class="configStatus.hasGitHubConfig ? 'success' : 'error'">
                    hasGitHubConfig: {{ configStatus.hasGitHubConfig }}
                </p>
                <p :class="configStatus.githubServiceConfigured ? 'success' : 'error'">
                    githubService.isConfigured: {{ configStatus.githubServiceConfigured }}
                </p>
                <pre>{{ JSON.stringify(configStatus, null, 2) }}</pre>
            </div>
        </div>

        <div class="test-section">
            <h2>步骤4: 模拟Vue实例的checkGitHubConfig</h2>
            <el-button @click="simulateVueCheck" type="primary">模拟Vue检查</el-button>
            <p v-if="vueCheckResult !== null" :class="vueCheckResult ? 'success' : 'error'">
                isGitHubConfigured: {{ vueCheckResult }}
            </p>
        </div>

        <div class="test-section">
            <h2>步骤5: 测试发布按钮</h2>
            <el-button
                @click="testPublish"
                :disabled="!isGitHubConfigured"
                type="success">
                {{ isGitHubConfigured ? '发布 (已启用)' : '发布 (已禁用)' }}
            </el-button>
            <p class="info">按钮状态: {{ isGitHubConfigured ? '启用' : '禁用' }}</p>
            <p v-if="publishResult" :class="publishResult.success ? 'success' : 'error'">
                {{ publishResult.message }}
            </p>
        </div>

        <div class="test-section">
            <h2>调试日志</h2>
            <pre>{{ debugLog }}</pre>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                configManagerLoaded: false,
                githubServiceLoaded: false,
                imageServiceLoaded: false,
                configSet: false,
                configStatus: null,
                vueCheckResult: null,
                isGitHubConfigured: false,
                publishResult: null,
                debugLog: ''
            },
            mounted() {
                this.log('Vue实例已挂载');
                this.checkScriptsLoaded();
            },
            methods: {
                log(msg) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.debugLog += `[${timestamp}] ${msg}\n`;
                    console.log(msg);
                },

                checkScriptsLoaded() {
                    this.configManagerLoaded = !!window.configManager;
                    this.githubServiceLoaded = !!window.githubService;
                    this.imageServiceLoaded = !!window.imageService;

                    this.log(`configManager: ${this.configManagerLoaded}`);
                    this.log(`githubService: ${this.githubServiceLoaded}`);
                    this.log(`imageService: ${this.imageServiceLoaded}`);
                },

                setTestConfig() {
                    this.log('设置测试配置...');

                    if (!window.configManager) {
                        this.$message.error('configManager未加载');
                        return;
                    }

                    const testConfig = {
                        token: 'ghp_test_token_123456',
                        owner: 'testuser',
                        repo: 'testrepo'
                    };

                    window.configManager.setGitHubConfig(testConfig);
                    this.log('配置已保存到configManager');

                    if (window.githubService) {
                        window.githubService.setConfig(testConfig);
                        this.log('配置已应用到githubService');
                    }

                    this.configSet = true;
                    this.$message.success('测试配置已设置');
                },

                checkConfigStatus() {
                    this.log('检查配置状态...');

                    const status = {
                        configManagerExists: !!window.configManager,
                        hasGitHubConfig: false,
                        getGitHubConfig: null,
                        githubServiceExists: !!window.githubService,
                        githubServiceConfigured: false,
                        githubServiceDetails: null
                    };

                    if (window.configManager) {
                        status.hasGitHubConfig = window.configManager.hasGitHubConfig();
                        status.getGitHubConfig = window.configManager.getGitHubConfig();
                        this.log(`hasGitHubConfig: ${status.hasGitHubConfig}`);
                    }

                    if (window.githubService) {
                        status.githubServiceConfigured = window.githubService.isConfigured();
                        status.githubServiceDetails = {
                            token: window.githubService.token ? '(已设置)' : '(未设置)',
                            owner: window.githubService.owner || '(未设置)',
                            repo: window.githubService.repo || '(未设置)'
                        };
                        this.log(`githubService.isConfigured: ${status.githubServiceConfigured}`);
                    }

                    this.configStatus = status;
                },

                simulateVueCheck() {
                    this.log('模拟Vue的checkGitHubConfig方法...');

                    if (!window.configManager) {
                        this.log('ERROR: configManager不存在');
                        this.vueCheckResult = false;
                        this.isGitHubConfigured = false;
                        return;
                    }

                    this.isGitHubConfigured = window.configManager.hasGitHubConfig();
                    this.vueCheckResult = this.isGitHubConfigured;

                    this.log(`isGitHubConfigured设置为: ${this.isGitHubConfigured}`);

                    if (this.isGitHubConfigured && window.githubService) {
                        const config = window.configManager.getGitHubConfig();
                        window.githubService.setConfig(config);
                        this.log('配置已同步到githubService');
                    }

                    this.$message({
                        message: `isGitHubConfigured = ${this.isGitHubConfigured}`,
                        type: this.isGitHubConfigured ? 'success' : 'warning'
                    });
                },

                testPublish() {
                    this.log('发布按钮被点击！');

                    if (!this.isGitHubConfigured) {
                        this.publishResult = {
                            success: false,
                            message: 'ERROR: 按钮应该被禁用，但仍然可以点击！'
                        };
                        this.$message.error(this.publishResult.message);
                        return;
                    }

                    this.publishResult = {
                        success: true,
                        message: '✓ 发布按钮工作正常！配置状态正确。'
                    };
                    this.$message.success('发布按钮测试成功！');
                    this.log('发布按钮测试成功');
                }
            }
        });
    </script>
</body>
</html>
