<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlogWriter - GitHub Auto Deploy</title>
    <meta name="version" content="1.2">

    <!-- 移动设备状态栏样式 -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-navbutton-color" content="#000000">

    <link rel="icon" type="image/png" href="./img/icons/write.png">
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vditor@3.9.4/dist/index.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor@3.9.4/dist/index.css">
    <script src="github-service.js"></script>
    <script src="picx-api.js"></script>
    <script src="image-uploader.js"></script>
    <link rel="stylesheet" href="picx-styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s ease;
        }

        /* 暗夜模式样式 */
        .dark-mode {
            background: #000000 !important;
            color: #e0e0e0;
        }

        .dark-mode .header {
            background: #000000 !important;
            border-bottom-color: #888;
        }

        .dark-mode .content-type-selector {
            background: #000000;
        }

        /* 克莱因蓝按钮样式 */
        .dark-mode .content-type-selector .el-button--primary,
        .dark-mode .el-button--primary {
            background: #002FA7 !important;
            border-color: #002FA7 !important;
            color: white !important;
        }

        .dark-mode .content-type-selector .el-button--primary:hover,
        .dark-mode .el-button--primary:hover {
            background: #0033B8 !important;
            border-color: #0033B8 !important;
            color: white !important;
        }

        /* 强制覆盖Element UI的默认样式 */
        .dark-mode .content-type-selector .el-button.el-button--primary {
            background-color: #002FA7 !important;
            border-color: #002FA7 !important;
        }

        .dark-mode .content-type-selector .el-button.el-button--primary:hover {
            background-color: #0033B8 !important;
            border-color: #0033B8 !important;
        }

        /* 发布按钮图标大小 */
        .publish-button .el-icon-upload {
            font-size: 18px !important;
        }

        /* 发布按钮成功动画 */
        .publish-button.success {
            background-color: #4CAF50 !important;
            border-color: #4CAF50 !important;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(76, 175, 80, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            }
        }

        /* GitHub配置按钮 */
        .github-config-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            background: #24292e;
            color: white;
            margin-left: 10px;
        }

        .github-config-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            background: #333;
        }

        .github-config-button .el-icon-setting {
            font-size: 18px;
        }



        /* Vditor YAML frontmatter 预览样式 */
        .vditor-preview .language-yaml,
        .vditor-preview pre[data-lang="yaml"],
        .vditor-preview code.language-yaml {
            background: #002FA7 !important;
            color: white !important;
            border: 1px solid #0033B8 !important;
        }

        /* Vditor 编辑器中的 YAML 代码块样式 */
        .vditor-ir pre.vditor-ir__marker--pre code,
        .vditor-wysiwyg pre code {
            background: #002FA7 !important;
            color: white !important;
        }

        /* 针对 frontmatter 的特殊样式 */
        .vditor-preview hr + pre,
        .vditor-preview hr + pre code {
            background: #002FA7 !important;
            color: white !important;
            border: 2px solid #0033B8 !important;
            border-radius: 6px !important;
        }

        /* 更强制的样式覆盖 - 针对所有可能的YAML显示 */
        .vditor-preview pre,
        .vditor-preview pre code,
        .vditor-preview .hljs,
        .vditor-preview .hljs-attr,
        .vditor-preview .hljs-string,
        .vditor-preview .hljs-literal {
            background: #002FA7 !important;
            color: white !important;
        }

        /* 确保YAML语法高亮也使用克莱因蓝 */
        .vditor-preview .hljs-attr {
            color: #FFD700 !important; /* 金色用于属性名 */
        }

        .vditor-preview .hljs-string {
            color: #90EE90 !important; /* 浅绿色用于字符串值 */
        }

        .vditor-preview .hljs-literal {
            color: #FFA500 !important; /* 橙色用于字面量 */
        }

        .dark-mode .editor-container {
            background: #000000 !important;
        }

        .dark-mode #vditor {
            background: #000000 !important;
        }

        .dark-mode .vditor {
            background: #000000 !important;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: none;
            padding: 15px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            color: white;
        }
        .content-type-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .type-buttons {
            display: flex;
            gap: 12px;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
        }

        /* 美化按钮样式 - 圆形按钮 */
        .el-button {
            border-radius: 25px !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            padding: 12px 24px !important;
        }

        .el-button:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .el-button.is-circle {
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
        }
        .editor-container {
            height: calc(100vh - 90px);
            padding: 0;
            background: #fafafa;
        }
        .metadata-editor {
            display: flex;
            gap: 15px;
            padding: 10px 15px;
            background-color: #000000;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 41px; /* Vditor toolbar height */
            z-index: 2;
        }
        .metadata-editor .el-input {
            flex: 1;
        }
        .metadata-editor .el-input[placeholder="文章标题"] {
            flex: 2; /* 标题框更宽 */
        }
        .metadata-editor .el-input__inner {
            height: 32px;
            line-height: 32px;
        }
        .dark-mode .el-input__inner {
            background-color: #1a1a1a !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }
        .dark-mode .el-input__inner:hover, .dark-mode .el-input__inner:focus {
            border-color: #002FA7 !important;
        }
        #vditor {
            height: 100%;
            border-radius: 0;
        }

        /* 编辑器字体大小 */
        .vditor-sv .vditor-sv__main textarea,
        .vditor-wysiwyg .vditor-wysiwyg__main {
            font-size: 16px !important;
            line-height: 1.6 !important;
        }

        /* 暗夜模式下的编辑器样式 */
        .dark-mode .editor-container {
            background: #000000 !important;
        }

        .dark-mode .header {
            background: #000000 !important;
        }

        .dark-mode .vditor-toolbar {
            background: #000000 !important;
            border-bottom-color: #888 !important;
        }

        .dark-mode .vditor-content {
            background: #000000 !important;
        }

        /* 确保所见即所得模式和即时渲染模式下编辑器背景为纯黑色 */
        .dark-mode .vditor-wysiwyg {
            background: #000000 !important;
        }

        .dark-mode .vditor-wysiwyg .vditor-wysiwyg__main {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        /* 更强制的所见即所得模式背景设置 */
        .dark-mode .vditor-wysiwyg__main,
        .dark-mode .vditor-wysiwyg__main .vditor-wysiwyg__main,
        .dark-mode .vditor-wysiwyg .vditor-wysiwyg__main .vditor-wysiwyg__main,
        .dark-mode .vditor-wysiwyg__main > div,
        .dark-mode .vditor-wysiwyg__main .vditor-wysiwyg__main > div {
            background: #000000 !important;
            background-color: #000000 !important;
            color: #e0e0e0 !important;
        }

        /* 针对所见即所得模式的编辑区域 */
        .dark-mode .vditor-wysiwyg__main[contenteditable="true"] {
            background: #000000 !important;
            background-color: #000000 !important;
            color: #e0e0e0 !important;
        }

        .dark-mode .vditor-ir {
            background: #000000 !important;
        }

        .dark-mode .vditor-ir .vditor-ir__main {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        .dark-mode .vditor-ir .vditor-ir__main textarea {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        /* 确保预览区域也是纯黑色背景 */
        .dark-mode .vditor-preview {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        /* 强制覆盖所有可能的Vditor背景样式 */
        .dark-mode .vditor-wysiwyg *,
        .dark-mode .vditor-ir * {
            background-color: transparent !important;
        }

        .dark-mode .vditor-wysiwyg,
        .dark-mode .vditor-wysiwyg__main,
        .dark-mode .vditor-ir,
        .dark-mode .vditor-ir__main {
            background: #000000 !important;
            background-color: #000000 !important;
        }

        .dark-mode .vditor-sv {
            background: #000000 !important;
        }

        .dark-mode .vditor-sv .vditor-sv__main {
            background: #000000 !important;
        }

        .dark-mode .vditor-sv .vditor-sv__preview {
            background: #000000 !important;
        }

        .dark-mode .vditor-sv .vditor-sv__preview .vditor-reset {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        .dark-mode .vditor-preview {
            background: #000000 !important;
        }

        .dark-mode .vditor-preview .vditor-reset {
            background: #000000 !important;
            color: #e0e0e0 !important;
        }

        /* 隐藏预览工具栏的Desktop/Tablet/Mobile等选项 */
        .vditor-preview__action,
        .vditor-preview__action--current,
        .vditor-preview__action[data-type="desktop"],
        .vditor-preview__action[data-type="tablet"],
        .vditor-preview__action[data-type="mobile"],
        .vditor-preview__action[data-type="mp-wechat"],
        .vditor-preview__action[data-type="zhihu"] {
            display: none !important;
        }

        /* 隐藏整个预览工具栏 */
        .vditor-preview__toolbar {
            display: none !important;
        }

        /* 美化GitHub配置弹窗 */
        .el-dialog, .el-dialog__wrapper {
            background: transparent !important;
        }

        .github-config-dialog .el-dialog {
            background: #161b22 !important;
            border-radius: 25px !important;
            border: 1px solid #30363d !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5) !important;
        }

        .github-config-dialog .el-dialog__header {
            background: #161b22 !important;
            color: #c9d1d9 !important;
            border-bottom: 1px solid #30363d !important;
        }

        .github-config-dialog .el-dialog__title {
            font-size: 18px !important;
            font-weight: 600;
            color: #e0e0e0 !important;
        }

        .github-config-dialog .el-dialog__body {
            background: #0d1117 !important;
            color: #c9d1d9 !important;
            padding: 25px 30px !important;
        }

        .github-config-dialog .el-form-item__label {
            color: #c9d1d9 !important;
            white-space: nowrap;
        }

        .github-config-dialog .el-input__inner {
            background: #010409 !important;
            border: 1px solid #30363d !important;
            color: #c9d1d9 !important;
            border-radius: 20px !important;
        }

        .github-config-dialog .el-input__inner:focus {
            border-color: #002FA7 !important;
            box-shadow: 0 0 0 3px rgba(0, 47, 167, 0.3) !important;
        }

        .github-config-dialog .token-instructions {
            font-size: 12px;
            color: #8b949e;
            margin-top: 8px;
            line-height: 1.6;
            background: #161b22;
            padding: 10px;
            border-radius: 6px;
        }

        .github-config-dialog .el-dialog__footer {
            background: #161b22 !important;
            border-top: 1px solid #30363d !important;
            padding: 15px 30px !important;
        }

        .github-config-dialog .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .github-config-dialog .test-result.success {
            background-color: rgba(34, 139, 34, 0.2);
            color: #3fb950;
            border: 1px solid rgba(34, 139, 34, 0.5);
        }

        .github-config-dialog .test-result.error {
            background-color: rgba(210, 4, 45, 0.2);
            color: #f85149;
            border: 1px solid rgba(210, 4, 45, 0.5);
        }

        .metadata-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .dark-mode .metadata-info {
            color: rgba(224, 224, 224, 0.8);
            background: rgba(255, 255, 255, 0.1);
        }

        /* 保存按钮克莱因蓝样式 - 更强制的选择器 */
        .save-button,
        .el-dialog .save-button,
        .el-dialog__footer .save-button,
        .el-dialog .el-button.save-button,
        .el-dialog__footer .el-button.save-button,
        button.save-button,
        .el-button--primary.save-button {
            background: #002FA7 !important;
            background-color: #002FA7 !important;
            border-color: #002FA7 !important;
            color: white !important;
            box-shadow: none !important;
        }

        .save-button:hover,
        .el-dialog .save-button:hover,
        .el-dialog__footer .save-button:hover,
        .el-dialog .el-button.save-button:hover,
        .el-dialog__footer .el-button.save-button:hover,
        button.save-button:hover,
        .el-button--primary.save-button:hover {
            background: #0033B8 !important;
            background-color: #0033B8 !important;
            border-color: #0033B8 !important;
            color: white !important;
            box-shadow: none !important;
        }

        .save-button:focus,
        .save-button:active,
        .el-dialog .save-button:focus,
        .el-dialog .save-button:active,
        .el-dialog__footer .save-button:focus,
        .el-dialog__footer .save-button:active,
        .el-dialog .el-button.save-button:focus,
        .el-dialog .el-button.save-button:active,
        .el-dialog__footer .el-button.save-button:focus,
        .el-dialog__footer .el-button.save-button:active,
        button.save-button:focus,
        button.save-button:active,
        .el-button--primary.save-button:focus,
        .el-button--primary.save-button:active {
            background: #002FA7 !important;
            background-color: #002FA7 !important;
            border-color: #002FA7 !important;
            color: white !important;
            box-shadow: none !important;
        }

        .dark-mode .el-button {
            background: #333 !important;
            border-color: #555 !important;
            color: #e0e0e0 !important;
        }

        .dark-mode .el-button:hover {
            background: #444 !important;
            border-color: #666 !important;
        }

        .dark-mode .el-button--primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-color: transparent !important;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .content-type-selector {
                /* 保持水平布局，让所有按钮在一行 */
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
            }

            .type-buttons {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }

            .action-buttons {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }

            /* 减小移动端按钮尺寸以适应一行显示 */
            .type-buttons .el-button {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            .github-config-button {
                width: 36px !important;
                height: 36px !important;
            }

            .picx-config-button {
                width: 36px !important;
                height: 36px !important;
            }

            .publish-button {
                padding: 8px 12px !important;
            }

            .picx-upload-button {
                padding: 4px 8px !important;
                font-size: 11px !important;
            }
        }

        @media (max-width: 480px) {
            .editor-container {
                height: calc(100vh - 120px);
            }

            /* 超小屏幕进一步优化按钮尺寸 */
            .type-buttons .el-button {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            .github-config-button {
                width: 32px !important;
                height: 32px !important;
            }

            .picx-config-button {
                width: 32px !important;
                height: 32px !important;
            }

            .publish-button {
                padding: 6px 10px !important;
            }

            .picx-upload-button {
                padding: 3px 6px !important;
                font-size: 10px !important;
            }

            .content-type-selector {
                gap: 6px;
            }

            .type-buttons,
            .action-buttons {
                gap: 6px;
            }
        }

        /* 移动端弹窗优化 */
        @media (max-width: 768px) {
            .el-dialog {
                width: 90% !important;
                max-width: 400px !important;
                margin: 0 auto !important;
                top: 15vh !important;
                transform: none !important;
            }

            .el-dialog__header {
                padding: 15px 20px 10px !important;
            }

            .el-dialog__body {
                padding: 10px 20px 20px !important;
                max-height: 60vh !important;
                overflow-y: auto !important;
            }

            .el-dialog__footer {
                padding: 10px 20px 15px !important;
            }
        }

        @media (max-width: 480px) {
            .el-dialog {
                width: 95% !important;
                max-width: 350px !important;
                top: 10vh !important;
            }

            .el-dialog__header {
                padding: 12px 15px 8px !important;
            }

            .el-dialog__body {
                padding: 8px 15px 15px !important;
                max-height: 65vh !important;
                font-size: 14px !important;
            }

            .el-dialog__footer {
                padding: 8px 15px 12px !important;
            }

            /* 移动端表单元素优化 */
            .el-input__inner {
                font-size: 16px !important; /* 防止iOS缩放 */
            }

            .el-button {
                padding: 8px 15px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="app">
        <div class="header">
            <div class="content-type-selector">
                <div class="type-buttons">
                    <el-button
                        v-for="(label, type) in contentTypeLabels"
                        :key="type"
                        :type="currentType === type ? 'primary' : 'default'"
                        @click="selectType(type)"
                        size="small">
                        <i :class="getTypeIcon(type)"></i>
                        {{ label }}
                    </el-button>
                    <button class="github-config-button" @click="configureGitHub" :title="isGitHubConfigured ? 'GitHub已配置' : '配置GitHub'">
                        <i class="el-icon-setting"></i>
                    </button>
                    <button class="picx-config-button" @click="configurePicX" :title="isPicXConfigured ? 'PicX已配置' : '配置PicX图床'">
                        <i class="el-icon-picture"></i>
                    </button>
                </div>
                <div class="action-buttons">
                    <button class="picx-upload-button" @click="selectAndUploadImage" :disabled="!isPicXConfigured" title="上传图片">
                        <i class="el-icon-picture-outline"></i> 图片
                    </button>
                    <el-button @click="publish" size="medium" type="success" icon="el-icon-upload" :disabled="!isGitHubConfigured" class="publish-button">
                    </el-button>
                    <input type="file" ref="picxFileInput" class="picx-upload-input" @change="handlePicXFileSelect" accept="image/*" multiple style="display: none;">
                </div>
            </div>
        </div>

        <div class="editor-container">
            <!-- 元数据编辑器将通过JS移动到Vditor工具栏下方 -->
            <div id="metadata-editor-wrapper" style="display: none;">
                <div class="metadata-editor" v-if="currentType !== 'general'">
                    <el-input v-if="metadataFields[currentType].some(f => f.key === 'title')" v-model="metadata.title" placeholder="Title" size="small"></el-input>
                    <el-input v-if="metadataFields[currentType].some(f => f.key === 'categories')" v-model="metadata.categories" placeholder="Categories (comma-separated)" size="small"></el-input>
                    <el-input v-if="metadataFields[currentType].some(f => f.key === 'description')" v-model="metadata.description" placeholder="Description" size="small"></el-input>
                </div>
            </div>
            <div id="vditor"></div>
        </div>



        <github-config
            :visible="githubConfigVisible"
            @close="githubConfigVisible = false"
            @save="handleGitHubConfigSave">
        </github-config>

        <picx-config
            :visible="picxConfigVisible"
            @close="picxConfigVisible = false"
            @save="handlePicXConfigSave">
        </picx-config>
    </div>

    <script>
        // 等待页面完全加载后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化GitHub服务
            window.githubService = new GitHubService();

        // 配置常量
        const contentTypes = {
            GENERAL: 'general',
            BLOG: 'blog',
            ESSAY: 'essay'
        };

        const contentTypeLabels = {
            [contentTypes.BLOG]: 'Blogs',
            [contentTypes.ESSAY]: 'Essays'
        };

        const metadataFields = {
            [contentTypes.BLOG]: [
                { key: 'title', label: '标题', type: 'text', required: true },
                { key: 'categories', label: '分类', type: 'tags' },
                { key: 'date', label: '发布日期', type: 'datetime' },
                { key: 'description', label: '描述', type: 'textarea' }
            ],
            [contentTypes.ESSAY]: [
                { key: 'categories', label: '分类', type: 'tags' },
                { key: 'pubDate', label: '发布日期', type: 'datetime' },
                { key: 'description', label: '描述', type: 'textarea' }
            ]
        };

        // 模板生成函数
        function generateContentWithMetadata(contentType, metadata, content) {
            if (contentType === contentTypes.GENERAL) {
                return content;
            }

            const frontmatter = Object.keys(metadata)
                .filter(key => metadata[key] !== undefined && metadata[key] !== '')
                .map(key => {
                    let value = metadata[key];
                    if (key === 'categories' && typeof value === 'string') {
                        value = value.split(',').map(cat => cat.trim()).filter(cat => cat);
                    }
                    if (typeof value === 'string' && value.includes(':')) {
                        value = `"${value}"`;
                    }
                    return `${key}: ${Array.isArray(value) ? JSON.stringify(value) : value}`;
                })
                .join('\n');

            return `---\n${frontmatter}\n---\n\n${content}`;
        }

        // GitHub配置组件
        Vue.component('github-config', {
            props: ['visible'],
            data() {
                return {
                    config: {
                        token: '',
                        owner: '',
                        repo: ''
                    },
                    testing: false,
                    testResult: null
                };
            },
            watch: {
                visible(newVal) {
                    if (newVal) {
                        this.loadConfig();
                    }
                }
            },
            methods: {
                loadConfig() {
                    const saved = localStorage.getItem('github-config');
                    if (saved) {
                        this.config = JSON.parse(saved);
                    }
                },
                async testConnection() {
                    if (!this.config.token || !this.config.owner || !this.config.repo) {
                        this.$message.warning('请填写完整的配置信息');
                        return;
                    }

                    this.testing = true;
                    this.testResult = null;

                    try {
                        // 临时设置配置进行测试
                        const tempService = new GitHubService();
                        tempService.setConfig(this.config);

                        const result = await tempService.testConnection();

                        if (result.success) {
                            this.testResult = {
                                success: true,
                                message: `连接成功！用户: ${result.user}，仓库: ${result.repo}，权限: ${result.permissions}`
                            };
                        } else {
                            this.testResult = {
                                success: false,
                                message: result.error
                            };
                        }
                    } catch (error) {
                        this.testResult = {
                            success: false,
                            message: `连接失败: ${error.message}`
                        };
                    } finally {
                        this.testing = false;
                    }
                },
                save() {
                    if (!this.config.token || !this.config.owner || !this.config.repo) {
                        this.$message.warning('请填写完整的配置信息');
                        return;
                    }

                    localStorage.setItem('github-config', JSON.stringify(this.config));
                    this.$emit('save', this.config);
                    this.close();
                },
                close() {
                    this.$emit('close');
                }
            },
            template: `
                <el-dialog
                    title="GitHub Configuration"
                    :visible.sync="visible"
                    width="550px"
                    @close="close"
                    custom-class="github-config-dialog">
                    <el-form :model="config" label-width="140px">
                        <el-form-item label="Personal Token">
                            <el-input
                                v-model="config.token"
                                type="password"
                                placeholder="Enter your GitHub Personal Access Token"
                                show-password>
                            </el-input>
                            <div class="token-instructions">
                                <strong>How to get a token:</strong><br>
                                1. GitHub → Settings → Developer settings<br>
                                2. Personal access tokens → Tokens (classic)<br>
                                3. Generate new token (classic)<br>
                                4. Check the <strong>repo</strong> scope → Generate token<br>
                                5. Copy the token and paste it here.
                            </div>
                        </el-form-item>

                        <el-form-item label="Repository Owner">
                            <el-input
                                v-model="config.owner"
                                placeholder="Your GitHub username or organization">
                            </el-input>
                        </el-form-item>

                        <el-form-item label="Repository Name">
                            <el-input
                                v-model="config.repo"
                                placeholder="The name of the repository">
                            </el-input>
                        </el-form-item>
                    </el-form>

                    <div v-if="testResult" :class="['test-result', testResult.success ? 'success' : 'error']">
                        {{ testResult.message }}
                    </div>

                    <div slot="footer" class="dialog-footer">
                        <el-button @click="testConnection" :loading="testing">Test Connection</el-button>
                        <el-button @click="close">Cancel</el-button>
                        <el-button type="primary" @click="save" class="save-button">Save Configuration</el-button>
                    </div>
                </el-dialog>
            `
        });

        // PicX 配置组件
        Vue.component('picx-config', {
            props: ['visible'],
            data() {
                return {
                    config: {
                        token: '',
                        owner: '',
                        repo: '',
                        branch: 'main',
                        path: 'images/',
                        cdn: 'jsdelivr',
                        compress: true,
                        quality: 0.8,
                        rename: true,
                        addPrefix: false,
                        prefix: ''
                    },
                    testing: false,
                    testResult: null,
                    cdnOptions: [
                        { value: 'github', label: 'GitHub Raw' },
                        { value: 'jsdelivr', label: 'jsDelivr CDN' },
                        { value: 'statically', label: 'Statically CDN' }
                    ]
                }
            },
            watch: {
                visible(newVal) {
                    if (newVal) {
                        this.loadConfig();
                    }
                }
            },
            methods: {
                loadConfig() {
                    if (window.picxAPI) {
                        this.config = { ...window.picxAPI.config };
                    }
                },
                async testConnection() {
                    if (!window.picxAPI) {
                        this.$message.error('PicX API 未初始化');
                        return;
                    }

                    this.testing = true;
                    this.testResult = null;

                    try {
                        // 临时设置配置进行测试
                        window.picxAPI.saveConfig(this.config);

                        const result = await window.picxAPI.testConnection();

                        if (result.success) {
                            this.testResult = { type: 'success', message: result.message };
                            this.$message.success('连接测试成功');
                        } else {
                            this.testResult = { type: 'error', message: result.message };
                            this.$message.error('连接测试失败');
                        }
                    } catch (error) {
                        this.testResult = { type: 'error', message: error.message };
                        this.$message.error(`连接测试失败: ${error.message}`);
                    } finally {
                        this.testing = false;
                    }
                },
                save() {
                    if (!this.config.token || !this.config.owner || !this.config.repo) {
                        this.$message.warning('请填写完整的 GitHub 配置信息');
                        return;
                    }

                    if (window.picxAPI) {
                        window.picxAPI.saveConfig(this.config);
                    }

                    this.$emit('save', this.config);
                    this.close();
                },
                close() {
                    this.$emit('close');
                }
            },
            template: `
                <el-dialog
                    title="PicX 图床配置"
                    :visible.sync="visible"
                    width="700px"
                    @close="close"
                    custom-class="image-config-dialog">
                    <el-form :model="config" label-width="120px">
                        <!-- GitHub 基础配置 -->
                        <el-form-item label="GitHub Token">
                            <el-input
                                v-model="config.token"
                                type="password"
                                placeholder="输入GitHub Personal Access Token"
                                show-password>
                            </el-input>
                            <div class="token-instructions">
                                <strong>获取Token步骤:</strong><br>
                                1. GitHub → Settings → Developer settings<br>
                                2. Personal access tokens → Tokens (classic)<br>
                                3. Generate new token → 勾选 <strong>repo</strong> 权限
                            </div>
                        </el-form-item>

                        <el-form-item label="仓库所有者">
                            <el-input
                                v-model="config.owner"
                                placeholder="GitHub用户名或组织名">
                            </el-input>
                        </el-form-item>

                        <el-form-item label="仓库名称">
                            <el-input
                                v-model="config.repo"
                                placeholder="用于存储图片的仓库名">
                            </el-input>
                        </el-form-item>

                        <el-form-item label="分支">
                            <el-input
                                v-model="config.branch"
                                placeholder="分支名 (默认: main)">
                            </el-input>
                        </el-form-item>

                        <el-form-item label="存储路径">
                            <el-input
                                v-model="config.path"
                                placeholder="图片存储路径 (默认: images/)">
                            </el-input>
                        </el-form-item>

                        <!-- CDN 配置 -->
                        <el-form-item label="CDN 服务">
                            <el-select v-model="config.cdn" placeholder="选择CDN服务">
                                <el-option
                                    v-for="cdn in cdnOptions"
                                    :key="cdn.value"
                                    :label="cdn.label"
                                    :value="cdn.value">
                                </el-option>
                            </el-select>
                            <div class="token-instructions">
                                <strong>CDN说明:</strong><br>
                                • GitHub Raw: 直接访问，国内较慢<br>
                                • jsDelivr: 免费CDN，国内访问快<br>
                                • Statically: 备用CDN服务
                            </div>
                        </el-form-item>

                        <!-- 图片处理配置 -->
                        <el-form-item label="图片压缩">
                            <el-switch v-model="config.compress"></el-switch>
                            <span style="margin-left: 10px; color: #666;">自动压缩图片以节省空间</span>
                        </el-form-item>

                        <el-form-item label="压缩质量" v-if="config.compress">
                            <el-slider
                                v-model="config.quality"
                                :min="0.1"
                                :max="1"
                                :step="0.1"
                                :format-tooltip="val => Math.round(val * 100) + '%'">
                            </el-slider>
                        </el-form-item>

                        <el-form-item label="文件重命名">
                            <el-switch v-model="config.rename"></el-switch>
                            <span style="margin-left: 10px; color: #666;">使用时间戳重命名文件</span>
                        </el-form-item>

                        <el-form-item label="添加前缀">
                            <el-switch v-model="config.addPrefix"></el-switch>
                            <span style="margin-left: 10px; color: #666;">为文件名添加自定义前缀</span>
                        </el-form-item>

                        <el-form-item label="前缀内容" v-if="config.addPrefix">
                            <el-input
                                v-model="config.prefix"
                                placeholder="输入文件名前缀">
                            </el-input>
                        </el-form-item>

                        <div v-if="testResult" :class="['test-result', testResult.type]">
                            {{ testResult.message }}
                        </div>
                    </el-form>

                    <div slot="footer" class="dialog-footer">
                        <el-button @click="testConnection" :loading="testing">测试连接</el-button>
                        <el-button @click="close">取消</el-button>
                        <el-button type="primary" @click="save">保存配置</el-button>
                    </div>
                </el-dialog>
            `
        });

        // 主Vue实例
        new Vue({
            el: '#app',
            data() {
                return {
                    vditor: null,
                    currentType: contentTypes.ESSAY, // 默认为Essays模式
                    metadata: {},
                    githubConfigVisible: false,
                    picxConfigVisible: false,
                    contentTypeLabels,
                    isGitHubConfigured: false,
                    isPicXConfigured: false,
                    isDarkMode: true,
                    metadataFields,
                    bodyContent: '',
                    hasUserInteracted: false
                };
            },

            mounted() {
                this.initTheme();
                this.setupMobileDefaults();
                this.initVditor();
                this.checkGitHubConfig();
                this.checkPicXConfig();
                this.checkForEditFile();
                this.selectType(this.currentType);
            },

            methods: {
                // 检测是否为移动设备
                isMobileDevice() {
                    const userAgent = navigator.userAgent.toLowerCase();
                    const mobileKeywords = ['mobile', 'android', 'iphone', 'ipad', 'ipod', 'blackberry', 'windows phone'];
                    return mobileKeywords.some(keyword => userAgent.includes(keyword)) ||
                           window.innerWidth <= 768;
                },

                // 为移动设备设置默认配置
                setupMobileDefaults() {
                    if (this.isMobileDevice()) {
                        // 设置为Essays模式
                        this.currentType = contentTypes.ESSAY;
                    }
                },

                initTheme() {
                    document.body.classList.add('dark-mode');
                },

                initVditor() {
                    const editorMode = 'ir';
                    this.vditor = new Vditor('vditor', {
                        height: '100%',
                        mode: editorMode,
                        theme: 'dark',
                        preview: {
                            theme: { current: 'dark' },
                            actions: []
                        },
                        toolbar: [
                            'emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|',
                            'list', 'ordered-list', 'check', 'outdent', 'indent', '|',
                            'quote', 'line', 'code', 'inline-code', 'insert-before', 'insert-after', '|',
                            'table', '|',
                            'undo', 'redo', '|',
                            'edit-mode', 'content-theme', 'code-theme', '|',
                            'outline', 'preview', 'fullscreen'
                        ],
                        cache: { enable: false },
                        after: function() {

                            // 将元数据编辑器移动到工具栏下方
                            const vditorElement = document.getElementById('vditor');
                            const toolbar = vditorElement.querySelector('.vditor-toolbar');
                            const metadataEditor = document.getElementById('metadata-editor-wrapper');
                            if (toolbar && metadataEditor) {
                                toolbar.insertAdjacentElement('afterend', metadataEditor);
                                metadataEditor.style.display = 'block';
                            }

                            // 绑定 input 事件，将编辑器内容同步到 bodyContent
                            this.vditor.vditor.element.addEventListener('input', () => {
                                this.bodyContent = this.vditor.getValue();
                            });

                            // 编辑器初始化完成后，触发自动聚焦和初始化拖拽
                            this.$nextTick(() => {
                                if (this.isMobileDevice()) {
                                    this.setupMobileAutoFocus();
                                } else {
                                    this.setupDesktopAutoFocus();
                                }

                                // 初始化图片上传器
                                this.initImageUploader();
                            });
                        }.bind(this)
                    });
                },

                checkGitHubConfig() {
                    const config = localStorage.getItem('github-config');
                    this.isGitHubConfigured = !!config;
                    if (config && window.githubService) {
                        const parsedConfig = JSON.parse(config);
                        window.githubService.setConfig(parsedConfig);
                    }
                },

                checkForEditFile() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const editFile = urlParams.get('edit');
                    if (editFile) {
                        this.loadFileForEdit(editFile);
                    }
                },

                async loadFileForEdit(filePath) {
                    if (!this.isGitHubConfigured) {
                        this.$message.warning('请先配置GitHub');
                        return;
                    }
                    try {
                        this.$message({ message: '正在加载文件...', type: 'info' });
                        const fileData = await window.githubService.getFile(filePath);
                        if (fileData) {
                            const { metadata, content } = this.parseContentWithFrontmatter(fileData.content);
                            
                            if (filePath.includes('/posts/')) {
                                this.currentType = contentTypes.BLOG;
                            } else if (filePath.includes('/essays/')) {
                                this.currentType = contentTypes.ESSAY;
                            }
                            
                            this.metadata = metadata;
                            this.bodyContent = content;
                            this.vditor.setValue(content);
                            this.$message.success('文件加载成功');
                        }
                    } catch (error) {
                        this.$message.error(`加载文件失败: ${error.message}`);
                    }
                },

                getTypeIcon(type) {
                    const icons = {
                        [contentTypes.BLOG]: 'el-icon-document',
                        [contentTypes.ESSAY]: 'el-icon-edit-outline'
                    };
                    return icons[type] || 'el-icon-document';
                },

                selectType(type) {
                    this.currentType = type;
                    this.resetMetadata(type);
                    this.bodyContent = '';
                    this.vditor.setValue('');
                },

                resetMetadata(type) {
                    const now = new Date();
                    let newMeta = {};

                    if (type === contentTypes.BLOG) {
                        const dateStr = now.toISOString().split('T')[0];
                        newMeta = {
                            title: '',
                            categories: 'Daily',
                            pubDate: dateStr,
                            description: ''
                        };
                    } else if (type === contentTypes.ESSAY) {
                        const dateTimeStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                        newMeta = {
                            pubDate: dateTimeStr,
                            description: "",
                            categories: "随笔"
                        };
                    }
                    this.metadata = newMeta;
                },

                setCursorToPosition(position) {
                    try {
                        // 方法1: 尝试使用Vditor的API
                        if (this.vditor.setCursorPosition) {
                            this.vditor.setCursorPosition(position);
                            return;
                        }
                    } catch (e) {
                        // Vditor API method failed, trying direct DOM manipulation
                    }

                    // 方法2: 直接操作DOM元素
                    const editor = this.vditor.vditor.element.querySelector('.vditor-textarea') ||
                                 this.vditor.vditor.element.querySelector('textarea') ||
                                 this.vditor.vditor.element.querySelector('.vditor-ir');

                    if (editor) {
                        if (editor.setSelectionRange) {
                            editor.setSelectionRange(position, position);
                            editor.focus();
                        } else if (editor.createTextRange) {
                            // IE兼容
                            const range = editor.createTextRange();
                            range.move('character', position);
                            range.select();
                        }
                    }
                },

                parseContentWithFrontmatter(content) {
                    // 检查是否有frontmatter
                    if (!content.startsWith('---')) {
                        return { metadata: {}, content: content };
                    }

                    const lines = content.split('\n');
                    let frontmatterEnd = -1;

                    // 找到frontmatter结束位置
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '---') {
                            frontmatterEnd = i;
                            break;
                        }
                    }

                    if (frontmatterEnd === -1) {
                        return { metadata: {}, content: content };
                    }

                    // 提取frontmatter
                    const frontmatterLines = lines.slice(1, frontmatterEnd);
                    const bodyContent = lines.slice(frontmatterEnd + 1).join('\n');

                    // 解析frontmatter
                    const metadata = {};
                    frontmatterLines.forEach(line => {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex > 0) {
                            const key = line.substring(0, colonIndex).trim();
                            let value = line.substring(colonIndex + 1).trim();

                            // 处理空值
                            if (!value || value.trim() === '') {
                                value = '';
                            } else {
                                // 移除引号
                                if ((value.startsWith('"') && value.endsWith('"')) ||
                                    (value.startsWith("'") && value.endsWith("'"))) {
                                    value = value.slice(1, -1);
                                }

                                // 处理数组格式
                                if (value.startsWith('[') && value.endsWith(']')) {
                                    try {
                                        value = JSON.parse(value);
                                    } catch (e) {
                                        // 如果解析失败，保持原值
                                    }
                                }
                            }

                            metadata[key] = value;
                        }
                    });

                    return { metadata, content: bodyContent };
                },

                async publish() {
                    if (!this.isGitHubConfigured) {
                        this.$message.warning('请先配置GitHub');
                        return;
                    }

                    // 从编辑器获取最新的正文
                    this.bodyContent = this.vditor.getValue();

                    // 检查是否有内容（正文不能为空）
                    if (!this.bodyContent.trim()) {
                        this.$message.warning('请先编写内容');
                        return;
                    }

                    if (this.currentType === contentTypes.BLOG && !this.metadata.title) {
                        this.$message.warning('请先设置标题');
                        return;
                    }

                    const finalContent = generateContentWithMetadata(this.currentType, this.metadata, this.bodyContent);

                    // 获取发布按钮元素
                    const publishButton = document.querySelector('.publish-button');

                    try {
                        this.$message({ message: '正在发布...', type: 'info' });

                        const result = await window.githubService.publishContent(
                            this.currentType,
                            this.metadata,
                            finalContent
                        );

                        if (result.success) {
                            // 添加成功状态动画
                            if (publishButton) {
                                publishButton.classList.add('success');

                                // 1.5秒后移除成功状态
                                setTimeout(() => {
                                    publishButton.classList.remove('success');
                                }, 1500);
                            }

                            this.$message({
                                message: `发布成功！文件已${result.action === 'add' ? '创建' : '更新'}`,
                                type: 'success'
                            });

                            this.selectType(this.currentType); // 重置
                        }
                    } catch (error) {
                        console.error('发布失败:', error);
                        this.$message.error(`发布失败: ${error.message}`);
                    }
                },

                configureGitHub() {
                    this.githubConfigVisible = true;
                },

                handleGitHubConfigSave(config) {
                    if (window.githubService) {
                        window.githubService.setConfig(config);
                        this.checkGitHubConfig();
                        this.$message.success('GitHub配置已保存');
                    }
                },

                // 检查PicX配置
                checkPicXConfig() {
                    if (window.picxAPI) {
                        this.isPicXConfigured = window.picxAPI.isConfigured();
                    }
                },

                // 配置PicX
                configurePicX() {
                    this.picxConfigVisible = true;
                },

                // 处理PicX配置保存
                handlePicXConfigSave(config) {
                    this.checkPicXConfig();
                    this.$message.success('PicX配置已保存');
                },

                // 初始化图片上传器
                initImageUploader() {
                    if (window.ImageUploader && window.picxAPI && this.vditor) {
                        this.imageUploader = new ImageUploader(this.vditor, window.picxAPI);
                    }
                },

                // 选择并上传图片
                selectAndUploadImage() {
                    if (!this.isPicXConfigured) {
                        this.$message.warning('请先配置 PicX 图床');
                        return;
                    }

                    this.$refs.picxFileInput.click();
                },

                // 处理文件选择
                async handlePicXFileSelect(event) {
                    const files = Array.from(event.target.files);

                    if (files.length === 0) return;

                    if (this.imageUploader) {
                        await this.imageUploader.uploadFiles(files);
                    }

                    // 清空文件输入框
                    event.target.value = '';
                },

                // 电脑端自动聚焦
                setupDesktopAutoFocus() {
                    // 多次尝试聚焦，确保成功
                    const attemptFocus = (attempt = 1) => {
                        this.focusEditor();

                        // 检查是否成功聚焦
                        setTimeout(() => {
                            const editorElement = this.vditor?.vditor?.ir?.element;
                            const isEditorFocused = document.activeElement === editorElement ||
                                                  editorElement?.contains(document.activeElement);

                            // 如果没有聚焦成功且尝试次数少于5次，继续尝试
                            if (!isEditorFocused && attempt < 5) {
                                attemptFocus(attempt + 1);
                            }
                        }, 300);
                    };

                    // 立即尝试聚焦
                    setTimeout(() => attemptFocus(), 100);

                    // 再次尝试（确保编辑器完全加载）
                    setTimeout(() => attemptFocus(), 500);

                    // 最后一次尝试
                    setTimeout(() => attemptFocus(), 1000);
                },

                // 移动端自动聚焦
                setupMobileAutoFocus() {
                    if (!this.isMobileDevice()) return;

                    // 多次尝试聚焦，确保成功
                    const attemptFocus = (attempt = 1) => {
                        this.focusEditor();

                        // 检查是否成功聚焦
                        setTimeout(() => {
                            const editorElement = this.vditor?.vditor?.ir?.element;
                            const isEditorFocused = document.activeElement === editorElement ||
                                                  editorElement?.contains(document.activeElement);

                            // 如果没有聚焦成功且尝试次数少于5次，继续尝试
                            if (!isEditorFocused && attempt < 5) {
                                attemptFocus(attempt + 1);
                            }
                        }, 300);
                    };

                    // 立即尝试聚焦
                    setTimeout(() => attemptFocus(), 100);

                    // 再次尝试（确保编辑器完全加载）
                    setTimeout(() => attemptFocus(), 500);

                    // 最后一次尝试
                    setTimeout(() => attemptFocus(), 1000);
                },



                // 聚焦编辑器
                focusEditor() {
                    if (!this.vditor || !this.vditor.vditor || !this.vditor.vditor.ir) {
                        // 如果编辑器还没准备好，稍后重试
                        setTimeout(() => this.focusEditor(), 200);
                        return;
                    }

                    try {
                        // 使用Vditor的内置聚焦方法
                        this.vditor.focus();

                        // 获取编辑器的文本区域
                        const editorElement = this.vditor.vditor.ir.element;
                        if (editorElement) {
                            // 确保编辑器获得焦点
                            editorElement.focus();

                            // 触发点击事件以确保光标显示
                            const clickEvent = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            editorElement.dispatchEvent(clickEvent);

                            // 将光标移到内容末尾
                            setTimeout(() => {
                                const range = document.createRange();
                                const selection = window.getSelection();

                                if (editorElement.childNodes.length > 0) {
                                    // 找到最后一个文本节点
                                    let lastNode = editorElement;
                                    while (lastNode.lastChild) {
                                        lastNode = lastNode.lastChild;
                                    }

                                    if (lastNode.nodeType === Node.TEXT_NODE) {
                                        range.setStart(lastNode, lastNode.textContent.length);
                                        range.setEnd(lastNode, lastNode.textContent.length);
                                    } else {
                                        range.selectNodeContents(editorElement);
                                        range.collapse(false);
                                    }
                                } else {
                                    range.setStart(editorElement, 0);
                                    range.setEnd(editorElement, 0);
                                }

                                selection.removeAllRanges();
                                selection.addRange(range);

                                // 确保光标可见
                                editorElement.focus();
                            }, 100);

                            // 滚动到编辑器位置
                            setTimeout(() => {
                                editorElement.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });
                            }, 200);
                        }
                    } catch (error) {
                        console.log('聚焦编辑器失败:', error);
                        // 备用方案：直接聚焦编辑器容器
                        try {
                            const vditorContainer = document.querySelector('#vditor .vditor-ir pre');
                            if (vditorContainer) {
                                vditorContainer.focus();
                            }
                        } catch (e) {
                            console.log('备用聚焦方案也失败:', e);
                        }
                    }
                }
            }
        });

        }); // 结束DOMContentLoaded事件监听器
    </script>
</body>
</html>
