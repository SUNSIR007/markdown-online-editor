<!DOCTYPE html>
<html lang="zh-CN" style="background: #000000 !important;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>启动画面过渡监测</title>

    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SplashMonitor">
    <meta name="color-scheme" content="dark">

    <!-- 启动画面配置 -->
    <link rel="apple-touch-startup-image" media="(device-width: 402px) and (device-height: 768px) and (-webkit-device-pixel-ratio: 3)" href="./img/splash/iphone-17-pro-portrait.png">
    <link rel="apple-touch-startup-image" href="./img/splash/iphone-17-pro-portrait.png">

    <script>
        // 记录所有关键时间点
        window.splashMonitor = {
            navigationStart: performance.timing.navigationStart,
            events: [],
            log: function(name, color) {
                const now = performance.now();
                this.events.push({
                    name: name,
                    time: now,
                    timestamp: Date.now(),
                    color: color || '#00ff00'
                });
                console.log(`[${now.toFixed(2)}ms] ${name}`);
            }
        };

        splashMonitor.log('脚本开始执行', '#ffff00');

        // 立即设置背景
        document.documentElement.style.cssText = 'background: #000000 !important; margin: 0; padding: 0;';
        splashMonitor.log('设置HTML背景', '#00ff00');

        // 监听visibilitychange - 可能与启动画面消失相关
        document.addEventListener('visibilitychange', function() {
            splashMonitor.log('visibilitychange: ' + document.visibilityState, '#ff00ff');
        });

        // 监听所有可能的事件
        ['readystatechange', 'DOMContentLoaded', 'load'].forEach(function(eventName) {
            window.addEventListener(eventName, function() {
                splashMonitor.log('Event: ' + eventName, '#00ffff');
            });
        });

        // 使用requestAnimationFrame检测第一帧
        let firstFrame = false;
        function checkFirstFrame() {
            if (!firstFrame) {
                firstFrame = true;
                splashMonitor.log('第一帧渲染', '#ff0000');
            }
        }
        requestAnimationFrame(checkFirstFrame);

        splashMonitor.log('脚本执行完成', '#ffff00');
    </script>

    <style>
        html, body {
            background: #000000 !important;
            color: #00ff00 !important;
            margin: 0;
            padding: 0;
            font-family: monospace;
        }

        /* 立即显示的内容 - 模拟启动画面 */
        #instant-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10000;
        }

        .instant-text {
            color: #888888;
            font-size: 32px;
            margin-bottom: 30px;
        }

        .instant-dots {
            display: flex;
            gap: 20px;
        }

        .instant-dot {
            width: 15px;
            height: 15px;
            border: 2px solid #666666;
            background: transparent;
        }

        #report {
            padding: 20px;
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <!-- 立即显示的内容 - 与启动画面完全一致 -->
    <div id="instant-content">
        <div class="instant-text">Loading...</div>
        <div class="instant-dots">
            <div class="instant-dot"></div>
            <div class="instant-dot"></div>
            <div class="instant-dot"></div>
        </div>
    </div>

    <div id="report">
        <h1>正在监测启动画面过渡...</h1>
    </div>

    <script>
        splashMonitor.log('body脚本开始', '#00ff00');

        // 等待页面加载完成后显示报告
        window.addEventListener('load', function() {
            setTimeout(function() {
                displayReport();
                // 移除instant-content
                const instant = document.getElementById('instant-content');
                if (instant) {
                    instant.style.opacity = '0';
                    instant.style.transition = 'opacity 0.3s';
                    setTimeout(function() {
                        instant.style.display = 'none';
                    }, 300);
                }
            }, 1000);
        });

        function displayReport() {
            const report = document.getElementById('report');
            const startTime = splashMonitor.events[0].time;

            let html = '<h2 style="color: #ffff00;">启动画面过渡监测报告</h2>';
            html += '<p style="color: #888;">精确记录从启动到渲染的每个时间点</p><hr>';

            html += '<h3 style="color: #00ffff;">事件时间轴</h3>';
            splashMonitor.events.forEach(function(event) {
                const relTime = (event.time - startTime).toFixed(2);
                html += `<div style="color: ${event.color}; margin: 5px 0;">`;
                html += `[+${relTime}ms] ${event.name}`;
                html += `</div>`;
            });

            // Paint Timing
            if (window.performance && window.performance.getEntriesByType) {
                const paintEntries = window.performance.getEntriesByType('paint');
                html += '<hr><h3 style="color: #00ffff;">绘制时间</h3>';
                paintEntries.forEach(function(entry) {
                    const color = entry.name.includes('first') ? '#ff00ff' : '#00ff00';
                    html += `<div style="color: ${color};">${entry.name}: ${entry.startTime.toFixed(2)}ms</div>`;
                });
            }

            // Navigation Timing
            const timing = performance.timing;
            html += '<hr><h3 style="color: #00ffff;">导航时间</h3>';
            html += `<div>从导航开始到responseStart: ${timing.responseStart - timing.navigationStart}ms</div>`;
            html += `<div>从responseStart到domLoading: ${timing.domLoading - timing.responseStart}ms</div>`;
            html += `<div>从domLoading到domComplete: ${timing.domComplete - timing.domLoading}ms</div>`;

            html += '<hr><h3 style="color: #ffff00;">关键发现</h3>';
            html += '<p style="color: #ff0000;">⚠️ 如果在打开PWA的瞬间看到白色闪烁，</p>';
            html += '<p style="color: #ff0000;">说明启动画面在first-paint之前就消失了。</p>';
            html += '<p style="color: #00ff00;">✓ 如果看到的是黑色的Loading界面，</p>';
            html += '<p style="color: #00ff00;">说明instant-content成功显示。</p>';

            report.innerHTML = html;
        }

        splashMonitor.log('body脚本结束', '#00ff00');
    </script>
</body>
</html>