<!DOCTYPE html>
<html lang="zh-CN" style="background: #000000 !important;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>启动画面检测器</title>

    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SplashTest">
    <meta name="color-scheme" content="dark">

    <!-- 启动画面 - 测试所有可能的匹配 -->
    <link rel="apple-touch-startup-image" media="(device-width: 402px) and (device-height: 768px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./img/splash/iphone-17-pro-portrait.png">
    <link rel="apple-touch-startup-image" media="(device-width: 402px) and (device-height: 768px) and (-webkit-device-pixel-ratio: 3)" href="./img/splash/iphone-17-pro-portrait.png">
    <link rel="apple-touch-startup-image" media="(device-width: 402px) and (-webkit-device-pixel-ratio: 3)" href="./img/splash/iphone-17-pro-portrait.png">
    <link rel="apple-touch-startup-image" href="./img/splash/iphone-17-pro-portrait.png">

    <script>
        // 检测是否在standalone模式（PWA）
        const isPWA = window.navigator.standalone === true ||
                      window.matchMedia('(display-mode: standalone)').matches;

        // 记录加载开始时间
        const loadStart = performance.now();

        // 检测背景颜色变化
        let backgroundChanges = [];

        function checkBackground() {
            const htmlBg = window.getComputedStyle(document.documentElement).backgroundColor;
            const bodyBg = document.body ? window.getComputedStyle(document.body).backgroundColor : 'N/A';

            backgroundChanges.push({
                time: performance.now() - loadStart,
                html: htmlBg,
                body: bodyBg
            });
        }

        // 每10ms检查一次背景色
        const bgChecker = setInterval(checkBackground, 10);

        window.addEventListener('load', function() {
            setTimeout(function() {
                clearInterval(bgChecker);
                displayReport();
            }, 1000);
        });

        function displayReport() {
            const report = document.getElementById('report');
            if (!report) return;

            let html = '<div style="font-family: monospace; padding: 20px;">';

            html += '<h2 style="color: #ffff00;">启动画面检测报告</h2>';
            html += `<p>运行模式: <span style="color: ${isPWA ? '#00ff00' : '#ff0000'};">${isPWA ? 'PWA模式 ✓' : 'Safari浏览器模式'}</span></p>`;
            html += '<hr>';

            // 检查启动画面资源是否存在
            html += '<h3 style="color: #00ffff;">启动画面资源检测</h3>';
            const splashImages = document.querySelectorAll('link[rel="apple-touch-startup-image"]');
            html += `<p>找到 ${splashImages.length} 个启动画面配置</p>`;

            splashImages.forEach(function(img, index) {
                const media = img.getAttribute('media') || '(通用fallback)';
                const href = img.getAttribute('href');
                html += `<div style="font-size: 11px; margin: 5px 0; color: #888;">`;
                html += `${index + 1}. ${media}<br>→ ${href}`;
                html += `</div>`;
            });

            html += '<hr><h3 style="color: #00ffff;">背景颜色变化记录</h3>';

            // 检查是否有非黑色背景出现
            const whiteFlashes = backgroundChanges.filter(function(change) {
                return change.html !== 'rgb(0, 0, 0)' &&
                       change.html !== 'rgba(0, 0, 0, 0)' &&
                       change.html.includes('255');
            });

            if (whiteFlashes.length > 0) {
                html += `<p style="color: #ff0000;">⚠️ 检测到 ${whiteFlashes.length} 次白色背景！</p>`;
                whiteFlashes.forEach(function(flash) {
                    html += `<div style="color: #ff0000;">时间: ${flash.time.toFixed(2)}ms - 背景: ${flash.html}</div>`;
                });
            } else {
                html += '<p style="color: #00ff00;">✓ 未检测到白色背景闪现</p>';
            }

            // 显示前10个背景变化
            html += '<p style="color: #888; margin-top: 10px;">前10次背景检测:</p>';
            backgroundChanges.slice(0, 10).forEach(function(change) {
                const isBlack = change.html === 'rgb(0, 0, 0)';
                html += `<div style="color: ${isBlack ? '#00ff00' : '#ff0000'}; font-size: 11px;">`;
                html += `[${change.time.toFixed(0)}ms] HTML: ${change.html}`;
                html += `</div>`;
            });

            html += '<hr><h3 style="color: #00ffff;">建议</h3>';
            if (isPWA) {
                if (whiteFlashes.length > 0) {
                    html += '<p style="color: #ff0000;">问题确认：在PWA模式下检测到白屏闪现</p>';
                    html += '<p>可能原因：</p>';
                    html += '<ul style="color: #ffff00;">';
                    html += '<li>启动画面和页面之间的空隙</li>';
                    html += '<li>CSS加载延迟</li>';
                    html += '<li>JavaScript执行延迟</li>';
                    html += '</ul>';
                } else {
                    html += '<p style="color: #00ff00;">✓ 在PWA模式下未检测到明显白屏</p>';
                }
            } else {
                html += '<p style="color: #ffff00;">请将此页面添加到主屏幕后测试</p>';
            }

            html += '</div>';
            report.innerHTML = html;
        }
    </script>

    <style>
        html, body {
            background: #000000 !important;
            color: #00ff00 !important;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body style="background: #000000 !important;">
    <div id="report" style="padding: 20px;">
        <h1>正在检测...</h1>
    </div>
</body>
</html>